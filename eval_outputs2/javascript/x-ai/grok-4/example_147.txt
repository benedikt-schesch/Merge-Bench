<think>
No reasoning found</think>
```javascript
  }

  var lastStoppedKey = null;
  function onKeyDown(e) {
    var cm = this;
<<<<<<< HEAD
    if (!cm.state.focused) onFocus(cm);
    if (signalDOMEvent(cm, e)) return;
=======
    ensureFocus(cm);
    if (signalDOMEvent(cm, e) || cm.options.onKeyEvent && cm.options.onKeyEvent(cm, addStop(e))) return;
    if (old_ie && e.keyCode == 27) e.returnValue = false;
    var code = e.keyCode;
>>>>>>> e1cfb7fd68e7988f508076063ebc17ddbabe2c92
    // IE does strange things with escape.
    if (ie_upto10 && e.keyCode == 27) e.returnValue = false;
    var code = e.keyCode;
    cm.display.shift = code == 16 || e.shiftKey;
    var handled = handleKeyBinding(cm, e);

```